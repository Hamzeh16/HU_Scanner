@model IEnumerable<ScannerModels.Model.ApplicationUser>
@{
    ViewData["Title"] = "Reset User Passwords";
}

<style>
    body {
        background-color: #f8f9fa;
        font-family: "Segoe UI", Arial, sans-serif;
    }

    .page-header {
        background: linear-gradient(90deg, #dc3545 0%, #b02a37 100%);
        color: #fff;
        padding: 25px 20px;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 35px;
        text-align: center;
    }

        .page-header h2 {
            font-weight: 700;
            margin: 0;
        }

    .table {
        background: #fff;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        width: 100%;
    }

    thead.table-danger th {
        color: #fff;
        background-color: #dc3545;
        border: none;
        text-align: center;
    }

    td, th {
        vertical-align: middle;
        text-align: center;
    }

    .btn-reset {
        background-color: #fff;
        border: 2px solid #dc3545;
        color: #dc3545;
        font-weight: 600;
        border-radius: 6px;
        padding: 5px 12px;
        transition: 0.2s ease;
    }

        .btn-reset:hover {
            background-color: #dc3545;
            color: #fff;
            transform: translateY(-2px);
        }

    .reset-section {
        display: none;
        background-color: #fff;
        border: 2px solid #dc3545;
        border-radius: 10px;
        padding: 20px;
        margin-top: 30px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

        .reset-section h5 {
            color: #b02a37;
            font-weight: 700;
            margin-bottom: 20px;
        }

    .alert {
        border-left: 4px solid #dc3545;
    }

    .btn-primary {
        background-color: #dc3545;
        border: none;
    }

        .btn-primary:hover {
            background-color: #b02a37;
        }

    .btn-cancel {
        border: 2px solid #6c757d;
        background: none;
        color: #6c757d;
        font-weight: 600;
        border-radius: 6px;
        padding: 5px 12px;
        transition: 0.2s ease;
    }

        .btn-cancel:hover {
            background-color: #6c757d;
            color: #fff;
        }

    .pwd-input {
        height: 42px !important;
        line-height: 42px !important;
        padding-right: 40px !important;
    }

    .password-toggle-btn {
        position: absolute;
        right: 22px;
        top: 42px !important;
        transform: none !important;
        width: 22px;
        height: 22px;
        padding: 0 !important;
        margin: 0 !important;
        display: flex;
        align-items: center;
        justify-content: center;
        background: none;
        border: none;
    }

        .password-toggle-btn:hover {
            color: #f63b4c;
        }

    .toggle-icon {
        display: block;
        width: 16px;
        height: 16px;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23718096' stroke-width='1.5'%3e%3cpath stroke-linecap='round' stroke-linejoin='round' d='M15 12a3 3 0 11-6 0 3 3 0 016 0z'/%3e%3cpath stroke-linecap='round' stroke-linejoin='round' d='M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z'/%3e%3c/svg%3e");
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        transition: background-image 0.2s ease;
    }

    .password-toggle-btn:hover .toggle-icon {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23f63b4c' stroke-width='1.5'%3e%3cpath stroke-linecap='round' stroke-linejoin='round' d='M15 12a3 3 0 11-6 0 3 3 0 016 0z'/%3e%3cpath stroke-linecap='round' stroke-linejoin='round' d='M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z'/%3e%3c/svg%3e");
    }

    .toggle-icon.show {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23718096' stroke-width='1.5'%3e%3cpath stroke-linecap='round' stroke-linejoin='round' d='M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 11-4.243-4.243m4.242 4.242L9.88 9.88'/%3e%3c/svg%3e");
    }

    .password-toggle-btn.hidden {
        display: none;
    }

</style>

<div class="page-header d-flex justify-content-between align-items-center">

    <a asp-area="Dean" asp-controller="Dashboard" asp-action="Index"
       class="btn btn-light"
       style="color:#dc3545; font-weight:600; border:2px solid white;">
        ⬅ Back
    </a>

    <div class="text-center flex-grow-1">
        <h2>🔐 Reset User Passwords</h2>
        <p class="mb-0">Select a user to securely reset their password</p>
    </div>

    <div style="width:90px;"></div>
</div>

@if (TempData["msg"] != null)
{
    <div class="alert alert-info mx-3">@TempData["msg"]</div>
}

<div class="container">
    <table class="table table-bordered table-striped align-middle">
        <thead class="table-danger">
            <tr>
                <th>#</th>
                <th>Name</th>
                <th>Email / Username</th>
                <th>Role</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @{
                int i = 1;
            }
            @foreach (var user in Model)
            {
                <tr>
                    <td>@i</td>
                    <td>@($"{user.FirstName} {user.LastName}")</td>
                    <td>@user.Email</td>
                    <td>
                        <span class="badge bg-danger-subtle text-danger border border-danger px-3 py-2">
                            @user.TypeUser
                        </span>
                    </td>
                    <td>
                        <button class="btn-reset" onclick="showResetForm('@user.Id', '@user.FirstName', '@user.LastName')">
                            <i class="bi bi-key"></i> Reset Password
                        </button>
                    </td>
                </tr>
                i++;
            }
        </tbody>
    </table>

    <!-- Hidden Reset Section -->
    <div id="resetSection" class="reset-section">
        <h5><i class="bi bi-lock"></i> Reset Password for <span id="selectedUserName" class="text-danger"></span></h5>
        <form asp-area="Dean" asp-controller="Users" asp-action="ResetPassword" method="post">
            <input type="hidden" id="UserId" name="userId" />
            <div class="row mb-3">
                <div class="col-md-6 position-relative">
                    <label class="form-label fw-semibold">New Password</label>
                    <input type="password" class="form-control pwd-input" name="newPassword" required />

                    <button type="button" class="password-toggle-btn">
                        <span class="toggle-icon"></span>
                    </button>
                </div>

                <div class="col-md-6 position-relative">
                    <label class="form-label fw-semibold">Confirm Password</label>
                    <input type="password" class="form-control pwd-input" id="confirmPassword" required />

                    <button type="button" class="password-toggle-btn">
                        <span class="toggle-icon"></span>
                    </button>

                    <div id="passwordError" class="text-danger small mt-1" style="display:none;">
                        Passwords do not match.
                    </div>
                </div>

            </div>
            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn-cancel" onclick="hideResetForm()">Cancel</button>
                <button type="submit" id="submitReset" class="btn btn-primary">Reset</button>
            </div>
        </form>
    </div>
</div>


<script>
    window.showResetForm = function(id, firstName, lastName) {
        const panel = document.getElementById("resetSection");
        if (!panel) return;
        panel.style.display = "block";
        document.getElementById("selectedUserName").innerText = firstName + " " + lastName;
        document.getElementById("UserId").value = id;
        document.getElementById("passwordError").style.display = "none";
        document.getElementById("confirmPassword").value = "";
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    };

    window.hideResetForm = function() {
        const panel = document.getElementById("resetSection");
        if (panel) panel.style.display = "none";
    };

    document.addEventListener('DOMContentLoaded', function() {
        const confirm = document.getElementById('confirmPassword');
        const submit = document.getElementById('submitReset');
        const error = document.getElementById('passwordError');
        const newPwd = document.querySelector('input[name="newPassword"]');

        if (!confirm || !newPwd) return;

        const validate = () => {
            if (newPwd.value !== confirm.value) {
                error.style.display = 'block';
                submit.disabled = true;
            } else {
                error.style.display = 'none';
                submit.disabled = false;
            }
        };

        confirm.addEventListener('input', validate);
        newPwd.addEventListener('input', validate);
    });

        document.querySelectorAll('.password-toggle-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
            const input = btn.parentElement.querySelector('.pwd-input');
            const icon = btn.querySelector('.toggle-icon');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.add('show');
            } else {
                input.type = 'password';
                icon.classList.remove('show');
            }
        });
    });

        // Hide/Show Eye Icon Based on Input Status
    document.querySelectorAll('.pwd-input').forEach((input) => {
        const btn = input.parentElement.querySelector('.password-toggle-btn');

        // Hide icon initially
        btn.classList.add('hidden');

        const toggleVisibility = () => {
            if (input.value.trim() === "") {
                btn.classList.add('hidden');
                input.type = 'password';  // reset if user cleared field
                btn.querySelector('.toggle-icon').classList.remove('show');
            } else {
                btn.classList.remove('hidden');
            }
        };

        input.addEventListener('input', toggleVisibility);
    });

</script>


